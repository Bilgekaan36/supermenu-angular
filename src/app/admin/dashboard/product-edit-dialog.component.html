<div class="product-edit-dialog">
  <h2 mat-dialog-title>
    <mat-icon>edit</mat-icon>
    Produkt bearbeiten
  </h2>

  <mat-dialog-content>
    <form [formGroup]="form" class="product-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Produkttitel</mat-label>
        <input matInput formControlName="title" required>
        <mat-icon matSuffix>title</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Beschreibung</mat-label>
        <textarea matInput formControlName="description" rows="3" required></textarea>
        <mat-icon matSuffix>description</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Preis</mat-label>
        <input matInput type="number" formControlName="price" min="0" step="0.01" required>
        <span matTextPrefix>€&nbsp;</span>
        <mat-icon matSuffix>euro</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Kategorie-Modus</mat-label>
        <mat-select formControlName="categoryMode" required>
          <mat-option value="existing">Vorhandene Kategorie wählen</mat-option>
          <mat-option value="new">Neue Kategorie anlegen</mat-option>
        </mat-select>
        <mat-icon matSuffix>tune</mat-icon>
      </mat-form-field>

      <mat-form-field *ngIf="form.get('categoryMode')?.value === 'existing'" appearance="outline" class="full-width">
        <mat-label>Kategorie</mat-label>
        <mat-select formControlName="category">
          <mat-option *ngFor="let opt of categoryOptions()" [value]="opt.value">{{ opt.label }}</mat-option>
        </mat-select>
        <mat-icon matSuffix>category</mat-icon>
      </mat-form-field>

      <mat-form-field *ngIf="form.get('categoryMode')?.value === 'new'" appearance="outline" class="full-width">
        <mat-label>Neue Kategorie</mat-label>
        <input matInput formControlName="new_category_title" placeholder="z.B. Burger" />
        <mat-icon matSuffix>add</mat-icon>
      </mat-form-field>

      <mat-divider></mat-divider>

      <!-- Untertitel -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Untertitel (optional)</mat-label>
        <input matInput formControlName="subtitle" placeholder="z.B. Premium Selection">
        <mat-icon matSuffix>subtitles</mat-icon>
      </mat-form-field>

      <!-- Darstellungsoptionen -->
      <div class="scale-row">
        <mat-form-field appearance="outline">
          <mat-label>Bildgröße</mat-label>
          <mat-select formControlName="image_scale" required>
            <mat-option value="xs">XS</mat-option>
            <mat-option value="sm">SM</mat-option>
            <mat-option value="md">MD</mat-option>
            <mat-option value="lg">LG</mat-option>
            <mat-option value="xl">XL</mat-option>
          </mat-select>
          <mat-icon matSuffix>photo_size_select_large</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Textgröße</mat-label>
          <mat-select formControlName="text_scale" required>
            <mat-option value="xs">XS</mat-option>
            <mat-option value="sm">SM</mat-option>
            <mat-option value="md">MD</mat-option>
            <mat-option value="lg">LG</mat-option>
            <mat-option value="xl">XL</mat-option>
          </mat-select>
          <mat-icon matSuffix>format_size</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Sortierung</mat-label>
          <input matInput type="number" formControlName="sort_order" min="0" required>
          <mat-icon matSuffix>sort</mat-icon>
        </mat-form-field>
      </div>

      <!-- Status Optionen -->
      <div class="checkbox-section">
        <mat-checkbox formControlName="is_active" color="primary">
          <span class="checkbox-label">
            <mat-icon>visibility</mat-icon>
            Produkt ist aktiv
          </span>
        </mat-checkbox>
        <mat-checkbox formControlName="is_available" color="primary">
          <span class="checkbox-label">
            <mat-icon>check_circle</mat-icon>
            Verfügbar
          </span>
        </mat-checkbox>
        <mat-checkbox formControlName="is_featured" color="accent">
          <span class="checkbox-label">
            <mat-icon>star</mat-icon>
            Featured
          </span>
        </mat-checkbox>
      </div>

      <mat-divider></mat-divider>

      <!-- Produktbild Auswahl -->
      <h3 class="section-title">
        <mat-icon>image</mat-icon>&nbsp;Produktbild
      </h3>
      <div class="image-selection-container">
        <div class="selected-image-preview" *ngIf="selectedProductImage">
          <img 
            id="product-image-preview"
            [src]="resolveImageUrl(selectedProductImage, 'product')" 
            [alt]="'Produktbild'" 
            (error)="onImageError($event)"
            (load)="onImageLoad($event)" />
          <div class="image-overlay">
            <button mat-icon-button color="warn" (click)="selectedProductImage = undefined">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        <button mat-raised-button color="primary" (click)="openImageSelection('product')" class="select-image-btn">
          <mat-icon>photo_library</mat-icon>
          {{ selectedProductImage ? 'Anderes Bild wählen' : 'Bild auswählen' }}
        </button>
      </div>

      <!-- Hintergrundbild Auswahl -->
      <h3 class="section-title">
        <mat-icon>wallpaper</mat-icon>&nbsp;Hintergrundbild
      </h3>
      <div class="image-selection-container">
        <div class="selected-image-preview" *ngIf="selectedBackgroundImage">
          <img 
            id="background-image-preview"
            [src]="resolveImageUrl(selectedBackgroundImage, 'background')" 
            [alt]="'Hintergrundbild'" 
            (error)="onImageError($event)"
            (load)="onImageLoad($event)" />
          <div class="image-overlay">
            <button mat-icon-button color="warn" (click)="selectedBackgroundImage = undefined">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        <button mat-raised-button color="primary" (click)="openImageSelection('background')" class="select-image-btn">
          <mat-icon>wallpaper</mat-icon>
          {{ selectedBackgroundImage ? 'Anderes Hintergrundbild wählen' : 'Hintergrundbild auswählen' }}
        </button>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="onCancel()" [disabled]="isSubmitting">
      <mat-icon>close</mat-icon>
      Abbrechen
    </button>
    <button mat-raised-button color="primary" type="button" (click)="onSubmit()" [disabled]="!form.valid || isSubmitting">
      <mat-icon>save</mat-icon>
      Änderungen speichern
    </button>
  </mat-dialog-actions>
</div>
